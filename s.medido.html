<!DOCTYPE xhtml>
<html lang="en-us">
    <head>
	<title>Medido Pump</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="UTF-8">
	<script src="zepto.min.js"></script>
	<link href="medido.css"  rel="stylesheet">
	<script src="gauge.min.js"></script>
	<script>
	 var flowRstr = 0;
	 var calFact = 0;
	 var gotFact = false;
	 var abcFact = 0;
	 //var aadamsAudio = document.getElementById('Aadams');
	 $(document).ready(function() {
	     var ipAddr = location.host;
	     var slider = document.getElementById("pumpSpeed");
	     var sliderOutput = document.getElementById("pumpDisp");
	     slider.oninput = function() {
		 sliderOutput.innerHTML = this.value;
	     }
	     var pressB=0;
	     var lastB=2;
	     $("#abcID").change(function(){
		 console.log("changed!");
		 abcFact = $("#abcID").val();
		 pressGauge.set(abcFact)
		 //console.log("var: ", $(this).val());
		 //console.log("aadamsAudio.paused: " + aadamsAudio.paused);
		 //console.log("aadamsAudio.currentTime: " + aadamsAudio.currentTime);
		 //console.log("aadamsAudio.ended: " + aadamsAudio.ended);
		 //if ($(this).val() == 0) {
		 //    alert("zero");
		 //    $("#Aadams").get(0).play();
		 //} else {
		 //    alert("not zero!")
		 //    $("#Aadams").get(0).pause();
		 //};
	     });
	     $("#Fill").click(function(){
		 pressB = 1;
		 $("#Fill").text("--> Fill <--");
		 $("#Empty").text("Empty");
		 $('.slider').css({backgroundColor: '#0400FF'});
		 lastB = 1;
	     });
	     $("#Empty").click(function(){
		 pressB = 3;
		 $("#Empty").text("--> Empty <--");
		 $("#Fill").text("Fill");
		 $('.slider').css({backgroundColor: '#FFCC00'});
		 lastB = 3;
	     });
	     $("#Off").click(function(){
		 pressB = 2;
		 $("#Fill").text("Fill");	 
		 $("#Empty").text("Empty");
		 lastB = 2;
		 slider.value = 0;
		 sliderOutput.innerHTML = 0;
	     });     
	     var pressC = 0;
	     $(".buttonClear").click(function(){
		 pressC = 1;
	     });
	     $("#calID").change(function(){
		 calFact = $("#calID").val();
	     });
	     //
	     function pollCB() {
		 var elems = oReq.responseText.split(",");
		 //
		 // elem[0]: Heap Size
		 //
		 var heapStr = Math.floor(Number(elems[0]));
		 heapStr = heapStr.toFixed();
		 $("#heapSize").html(heapStr)
		 //
		 // elem[1]: Total Fuel Flow (oz)
		 //
		 var flowCstr= Math.floor(Number(elems[1])*10)/10.;
		 flowCstr = flowCstr.toFixed(1);
		 $("#totalFuelFlow").html(flowCstr)
		 var fuelModulo = Math.abs(flowCstr % 10);
		 $('#fuelMeter').val(fuelModulo)
		 //
		 // elem[2]: Flow Rate (oz/min)
		 //
		 flowRstr = Math.floor(Number(Number(elems[2])) * 10) / 10.;
		 flowRstr = flowRstr.toFixed(1);
		 $("#fuelFlowRate").html(flowRstr)
		 flowGauge.set(flowRstr)
		 //
		 // elem[3]: Running Time (secs)
		 //
		 var mins = Math.floor(Number(elems[3]) / 60);
		 var secs = Math.floor(10 * (Number(elems[3]) - mins*60))/10.;
		 var timeStr;
		 timeStr = mins.toFixed().padStart(2,"0")+":"+secs.toFixed(1).padStart(4,"0");
		 $("#runningTime").html(timeStr)
		 //
		 // elem[4]: Calibration factor (pulses per oz)
		 //
		 var ppOz = Math.floor( (Number(elems[4]) + 0.5)) / 100;
		 if (!gotFact) {
		     calFact = ppOz.toFixed(2);
		     //console.log("calFact:" + calFact);
		     $("#calID").val(calFact);		 
		     gotFact = true;
		 }
		 //
		 // elem[5]: Fuel pressure (psi)
		 //
		 var pressPSI = Number(elems[5]).toFixed(1);
                 if (pressPSI < 0.1) {
                    pressPSI = 0;
                 }
		 pressGauge.set(pressPSI)
		 $('#fuelPressure').html(pressPSI)
		 //
		 // Reset next poll
		 //
		 window.setTimeout(doPoll, 250);
	     };
	     //
	     function doPoll() {
		 //console.log("in doPoll");
		 //const oReq = new XMLHttpRequest();
		 var pumpURL = "http://" + ipAddr
		 var getURL = pumpURL + "?";
		 getURL = getURL + "pS=" + slider.value + "&";
		 getURL = getURL + "pB=" + pressB + "&";
		 getURL = getURL + "pC=" + pressC;
		 var temp = Math.floor(calFact * 100 + 0.5)
		 if (calFact !== 0) {
		     getURL = getURL + "&cF=" + temp;
		 };
		 pressB = 0;
		 pressC = 0;
		 oReq.open("GET", getURL);
		 //fire the missiles
		 oReq.send();
	     }
	     //
	     //set up listener for when server responds
	     //
	     const oReq = new XMLHttpRequest();
	     oReq.addEventListener("load", pollCB)
	     //
	     if (ipAddr !== '') { 
		 doPoll();
	     }
	 });
	 //
	 //
	</script>
    </head>
    <body>
	<div style="font-size: 20px;font-weight: bold;text-align: center;width: 95% ;color: blue ">
	    MedidoPump
	</div>
	<div id="gaugediv">
	    <canvas id="pressGauge"></canvas>
	    <canvas id="flowGauge"></canvas>
	</div>
	<br>
	<div style="font-size: 18px;font-weight: bold; line-height: 24px; text-align: center">
	    Fuel Flow Rate <span id="fuelFlowRate">0</span> oz/min
	    <br>
	    Fuel Supply Pressure <span id ="fuelPressure">0</span> psi
	    <hr>
	    <meter min="0" max="10" value="0" id="fuelMeter">meter</meter>
	    Fuel Flow
	    <span id="totalFuelFlow">0</span> oz <button class="buttonClear"> Clear </button>
	    <hr>
	    <input type="range" min="0" max="100" class="slider" value="0" id="pumpSpeed">
	    Pump Speed (%): <span id="pumpDisp">0</span>
	    <hr>
	    Running Time <span id="runningTime">0</span>
	    <hr>
	</div>
	
	<div>
	    <button class="button buttonFill"  id="Fill" >Fill </button>
	    <button class="button buttonOff"   id="Off"  >Off  </button>
	    <button class="button buttonEmpty" id="Empty">Empty</button>
	    <br>
	    Heap: <span id="heapSize">0</span>
	</div>
	<br>
	Calibration (pulses/oz):
	<input type="number"name="calFactor" size="4" min="20" max="90" step="0.01"
	       id="calID" value=""
	       title="Enter calibration constant in pulses/oz" />
	<br>
	Abc Parameter:
	<input type="number" size="4"
	       name="abcFactor" id="abcID" value=""
	       title="Enter abc" />
	<script>
	 var flowTarget = document.getElementById('flowGauge'); // your canvas element
	 var pressTarget = document.getElementById('pressGauge'); // your canvas element
	 var flowOpts = {
	     angle: 0.05, // The span of the gauge arc
	     lineWidth: 0.35, // The line thickness
	     radiusScale: .9, // Relative radius
	     pointer: {
		 length: 0.6, // Relative to gauge radius
		 strokeWidth: 0.035, // The thickness
		 color: '#000000', // Fill color
	     },
	     renderTicks: {
		 divisions: 6,
		 subDivisions: 4,
		 divLength: 0.3,
		 subLength: 0.15
	     },
	     staticLabels: {
		 labels: [-60,-40,-20,0,20,40, 60],
		 color: 'black',
		 font: "90% sans serif"
	     },
	     limitMax: true,     // If false, max value increases automatically if value > maxValue
	     limitMin: true,     // If true, the min value of the gauge will be fixed
	     generateGradient: true,
	     highDpiSupport: true,     // High resolution support
	     colorStart: '#0039e6',   // Colors
	     colorStop: '#0039e6',    // just experiment with them
	     strokeColor: '#E0E0E0',  // to see which ones work best for you
	     fontSize: 30,
	     staticZones: [
		 {strokeStyle: "#FFCC00", min: -60, max: -2}, // 
		 {strokeStyle: "#e0e0e0", min: -2,  max: 2},  // Grey near zero
		 {strokeStyle: "#0400FF", min: 2,   max: 60}, // 
	     ],
	 };
	 var pressOpts = {
	     angle: 0.05, // The span of the gauge arc
	     lineWidth: 0.15, // The line thickness
	     radiusScale: .5, // Relative radius
	     pointer: {
		 length: 0.50, // // Relative to gauge radius
		 strokeWidth: 0.035, // The thickness
		 color: '#000000' // Fill color
	     },
	     renderTicks: {
		 divisions: 5,
		 subDivisions: 2,
		 divLength: 0.3,
		 subLength: 0.15
	     },
	     limitMax: true,     // If false, max value increases automatically if value > maxValue
	     limitMin: true,     // If true, the min value of the gauge will be fixed
	     generateGradient: true,
	     highDpiSupport: true,     // High resolution support
	     colorStart: '#0039e6',   // Colors
	     colorStop: '#0039e6',    // just experiment with them
	     strokeColor: '#E0E0E0',  // to see which ones work best for you
	     //fontSize: 30,
	     percentColors: [[0.0, "#00FF00" ], [1.0, "#FF0000"]],
	     strokeColor: '#E0E0E0',
	     //staticZones: [
		 //{strokeStyle: "#00FF00", min: 0, max: 2}, // 
		 //{strokeStyle: "#FF0000", min: 2, max: 5}, // 
	     //],
	 };
	 
	 var flowGauge = new Gauge(flowTarget).setOptions(flowOpts); // create sexy gauge!
	 var pressGauge = new Gauge(pressTarget).setOptions(pressOpts)
	 flowGauge.maxValue = 60; // set max gauge value
	 flowGauge.setMinValue(-60);  // Prefer setter over gauge.minValue = 0
	 flowGauge.animationSpeed = 10; // set animation speed (32 is default value)
	 pressGauge.maxValue = 10; // set max gauge value
	 pressGauge.setMinValue(0);  // Prefer setter over gauge.minValue = 0
	 pressGauge.animationSpeed = 10; // set animation speed (32 is default value)

	 pressGauge.set(abcFact); // set actual value	 
	 flowGauge.set(flowRstr); // set actual value
	 
	</script>
	
    </body>
</html>
