<!DOCTYPE xhtml>
<html lang="en-us">
    <head>
	<title>Medido Pump</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="UTF-8">
	<script src="zepto.min.js"></script>
	<link href="medido.css"  rel="stylesheet">
	<audio class="aud" id="Aadams" controls preload="auto">
	    <source src="mailsin.mp3" type="audio/mpeg">
	</audio>
	<script src="gauge.min.js"></script>
	<script>
	 var flowRstr = 0;
	 var calFact = 0;
	 var gotFact = false;
	 var abcFact = 0;
	 $(document).ready(function() {
	     var ipAddr = location.host;
	     var slider = document.getElementById("pumpSpeed");
	     var sliderOutput = document.getElementById("pumpDisp");
	     slider.oninput = function() {
		 sliderOutput.innerHTML = this.value;
	     }
	     var pressB=0;
	     var lastB=2;
	     $("#abcID").change(function(){
		 console.log("play")
		 if ($(this).paused == true) {
		     console.log("true")
		     $(this).get(0).play()
		 } else {
		     console.log("false")
		     $(this).get(0).pause()		     
		 };
		 // $("#Aadams").get(0).play()
	     });
	     $("#Fill").click(function(){
		 pressB = 1;
		 $("#Fill").text("--> Fill <--");
		 $("#Empty").text("Empty");
		 $('.slider').css({backgroundColor: '#0400FF'});
		 lastB = 1;
	     });
	     $("#Empty").click(function(){
		 pressB = 3;
		 $("#Empty").text("--> Empty <--");
		 $("#Fill").text("Fill");
		 $('.slider').css({backgroundColor: '#FFCC00'});
		 lastB = 3;
	     });
	     $("#Off").click(function(){
		 pressB = 2;
		 $("#Fill").text("Fill");	 
		 $("#Empty").text("Empty");
		 lastB = 2;
		 slider.value = 0;
		 sliderOutput.innerHTML = 0;
	     });     
	     var pressC = 0;
	     $(".buttonClear").click(function(){
		 pressC = 1;
	     });
	     $("#calID").change(function(){
		 calFact = $("#calID").val();
	     });
	     //$("#abcID").change(function(){
	     //abcFact = $("#abcID").val();
	     //if (abcFact > 40 || abcFact < -40) {
	     //    alert("Range is ...");
	     //};
	     //	 gauge.set(abcFact)
	     // var abcMod = Math.abs(abcFact) % 100;
	     //$('#fuelMeter').val(abcMod)		 
	     //});
	     //
	     function pollCB() {
		 var elems = oReq.responseText.split(",");
		 //
		 var heapStr = Math.floor(Number(elems[0]));
		 heapStr = heapStr.toFixed();
		 $("#heapSize").html(heapStr)
		 //
		 var flowCstr= Math.floor(Number(elems[1])*10)/10.;
		 flowCstr = flowCstr.toFixed(1);
		 $("#totalFuelFlow").html(flowCstr)
		 var fuelModulo = flowCstr % 100;
		 $('#fuelMeter').val(fuelModulo)
		 //
		 flowRstr = Math.floor(Number(Number(elems[2])) * 10) / 10.;
		 flowRstr = flowRstr.toFixed(1);
		 $("#fuelFlowRate").html(flowRstr)
		 gauge.set(flowRstr)
		 //
		 var mins = Math.floor(Number(elems[3]) / 60);
		 var secs = Math.floor(10 * (Number(elems[3]) - mins*60))/10.;
		 var timeStr;
		 timeStr = mins.toFixed().padStart(2,"0")+":"+secs.toFixed(1).padStart(4,"0");
		 $("#runningTime").html(timeStr)
		 //
		 var ppOz = Math.floor( (Number(elems[4]) + 0.5)) / 100;
		 if (!gotFact) {
		     calFact = ppOz.toFixed(2);
		     //console.log("calFact:" + calFact);
		     $("#calID").val(calFact);		 
		     gotFact = true;
		 }
		 window.setTimeout(doPoll, 250);
	     };
	     //
	     function doPoll() {
		 //console.log("in doPoll");
		 //const oReq = new XMLHttpRequest();
		 var pumpURL = "http://" + ipAddr
		 var getURL = pumpURL + "?";
		 getURL = getURL + "pS=" + slider.value + "&";
		 getURL = getURL + "pB=" + pressB + "&";
		 getURL = getURL + "pC=" + pressC;
		 var temp = Math.floor(calFact * 100 + 0.5)
		 if (calFact !== 0) {
		     getURL = getURL + "&cF=" + temp;
		 };
		 pressB = 0;
		 pressC = 0;
		 oReq.open("GET", getURL);
		 //fire the missiles
		 oReq.send();
	     }
	     //
	     //set up listener for when server responds
	     //
	     const oReq = new XMLHttpRequest();
	     oReq.addEventListener("load", pollCB)
	     //
	     if (ipAddr !== '') { 
		 doPoll();
	     }
	 });
	 //
	 //
	</script>
    </head>
    <body>
	<div style="font-size: 20px;font-weight: bold;text-align: center;width: 95% ;color: blue ">
	    MedidoPump
	</div>
	<canvas id="gauge"></canvas>
	<br>
	<div style="font-size: 18px;font-weight: bold; line-height: 30px; text-align: center">
	    Fuel Flow Rate <span id="fuelFlowRate">0</span> oz/min
	    <hr>
	    <meter min="0" max="100" value="50" id="fuelMeter">meter</meter>
	    Fuel Flow
	    <span id="totalFuelFlow">0</span> oz <button class="buttonClear"> Clear </button>
	    <hr>
	    <input type="range" min="0" max="100" class="slider" value="0" id="pumpSpeed">
	    Pump Speed (%): <span id="pumpDisp">0</span>
	    <hr>
	    Running Time <span id="runningTime">0</span>
	    <hr>
	</div>
	
	<div>
	    <button class="button buttonFill"  id="Fill" >Fill </button>
	    <button class="button buttonOff"   id="Off"  >Off  </button>
	    <button class="button buttonEmpty" id="Empty">Empty</button>
	    <br>
	    Heap: <span id="heapSize">0</span>
	</div>
	<br>
	Calibration (pulses/oz):
	<input type="number"name="calFactor" size="4" min="20" max="90" step="0.01"
	       id="calID" value=""
	       title="Enter calibration constant in pulses/oz" />
	<br>
	Abc Parameter:
	<input type="number" size="4"
	       name="abcFactor" id="abcID" value=""
	       title="Enter abc" />
	<br>
	<script>
	 var target = document.getElementById('gauge'); // your canvas element
	 var opts = {
	     angle: 0.05, // The span of the gauge arc
	     lineWidth: 0.35, // The line thickness
	     radiusScale: .9, // Relative radius
	     pointer: {
		 length: 0.6, // // Relative to gauge radius
		 strokeWidth: 0.035, // The thickness
		 color: '#000000' // Fill color
	     },
	     renderTicks: {
		 divisions: 8,
		 subDivisions: 4,
		 divLength: 0.3,
		 subLength: 0.15
	     },
	     staticLabels: {
		 labels: [-40,-20,0,20,40],
		 color: 'black',
		 font: "90% sans serif"
	     },
	     limitMax: true,     // If false, max value increases automatically if value > maxValue
	     limitMin: true,     // If true, the min value of the gauge will be fixed
	     generateGradient: true,
	     //highDpiSupport: true,     // High resolution support
	     colorStart: '#0039e6',   // Colors
	     colorStop: '#0039e6',    // just experiment with them
	     strokeColor: '#E0E0E0',  // to see which ones work best for you
	     fontSize: 30,
	     staticZones: [
		 {strokeStyle: "#FFCC00", min: -40, max: -2}, // 
		 {strokeStyle: "#e0e0e0", min: -2,  max: 2},  // Grey near zero
		 {strokeStyle: "#0400FF", min: 2,   max: 40}, // 
	     ],
	 };
	 var gauge = new Gauge(target).setOptions(opts); // create sexy gauge!
	 gauge.maxValue = 40; // set max gauge value
	 gauge.setMinValue(-40);  // Prefer setter over gauge.minValue = 0
	 gauge.animationSpeed = 10; // set animation speed (32 is default value)
	 gauge.set(flowRstr); // set actual value
	</script>
	
    </body>
</html>
