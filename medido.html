<!DOCTYPE xhtml>
<html lang="en-us">
    <head>
	<title>Medido Pump</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="UTF-8">
	<script src="zepto.min.js"></script>
	<script src="gauge.min.js"></script>
	<script>
	 var flowRstr = 0;
	 $(document).ready(function() {
	     var ipAddr = location.host;
	     var slider = document.getElementById("pumpSpeed");
	     var sliderOutput = document.getElementById("pumpDisp");
	     slider.oninput = function() {
		 sliderOutput.innerHTML = this.value;
	     }
	     var pressB=0;
	     var lastB=2;
	     $("#Fill").click(function(){
		 pressB = 1;
		 //$("#Fill").text("--> Fill <--");
		 //$("#Empty").text("Empty");
		 $('.slider').css({backgroundColor: '#16aa20'});
		 lastB = 1;
	     });
	     $("#Empty").click(function(){
		 pressB = 3;
		 //$("#Empty").text("--> Empty <--");
		 //$("#Fill").text("Fill");
		 $('.slider').css({backgroundColor: '#f44336'});
		 lastB = 3;
	     });
	     $("#Off").click(function(){
		 pressB = 2;
		 //$("#Fill").text("Fill");	 
		 //$("#Empty").text("Empty");
		 lastB = 2;
		 slider.value = 0;
		 sliderOutput.innerHTML = 0;
	     });     
	     var pressC = 0;
	     $(".buttonClear").click(function(){
		 pressC = 1;
	     });
	     //
	     function pollCB() {
		 var elems = oReq.responseText.split(",");
		 var mins = Math.floor(elems[3]/60);
		 var secs = Math.floor(10*(elems[3] - mins*60))/10.;
		 var timeStr;
		 timeStr = mins.toFixed().padStart(2,"0")+":"+secs.toFixed(1).padStart(4,"0");
		 var heapStr = Math.floor(elems[0]);
		 heapStr = heapStr.toFixed();
		 var flowCstr= Math.floor(elems[1]*10)/10.;
		 flowCstr = flowCstr.toFixed(1);
		 flowRstr = Math.floor(elems[2]*10)/10.;
		 flowRstr = flowRstr.toFixed(1);
		 document.getElementById("heapSize").innerHTML = heapStr;
		 document.getElementById("totalFuelFlow").innerHTML = flowCstr;
		 document.getElementById("fuelFlowRate").innerHTML = flowRstr;	
		 document.getElementById("runningTime").innerHTML = timeStr;
		 window.setTimeout(doPoll, 250);
	     };
	     //
	     function doPoll() {
		 //console.log("in doPoll");
		 //const oReq = new XMLHttpRequest();
		 var pumpURL = "http://" + ipAddr
		 var getURL = pumpURL + "?";
		 getURL = getURL + "pumpSpeed=" + slider.value + "&";
		 getURL = getURL + "pressB=" + pressB + "&";
		 getURL = getURL + "pressC=" + pressC;
		 pressB = 0;
		 pressC = 0;
		 oReq.open("GET", getURL);
		 //fire the missiles
		 oReq.send();
	     }
	     //
	     //set up listener for when server responds
	     //
	     const oReq = new XMLHttpRequest();
	     oReq.addEventListener("load", pollCB)
	     //
	     if (ipAddr !== '') { 
		 doPoll();
	     }
	 });
	 //
	</script>
	<style>
	 html {
	     font-family: "Arial",Helvetica, sans-serif;
	 }
	 .button {
	     background-color: #4CAF50; /* Green */
	     border: none;
	     color: white;
	     padding: 12px 25px;
	     text-align: center;
	     text-decoration: none;
	     display: block;
	     width: 95%;
	     font-size: 30px;
	     /* margin: 4px 8px; */
	     cursor: pointer;
	 }
	 .buttonClear {
	     background-color: #4CAF50; /* Green */
	     border: none;
	     color: white;
	     padding: 6px;
	     text-align: center;
	     text-decoration: none;
	     display: inline-block;
	     font-size: 18px;
	     border-radius: 16px;
	     margin: 4px 2px;
	     cursor: pointer;
	 }
	 .buttonFill {background-color:  #16aa20;}  /* Green */
	 .buttonEmpty {background-color: #f44336;}  /* Red   */ 
	 .buttonOff {background-color:   #555555;}  /* Black */
	 .slidecontainer {
	     width: 100%;
	 }
	 .slider {
	     -webkit-appearance: none;
	     width: 95%;
	     height: 60px;
	     background: #16aa20;
	     outline: none;
	     opacity: 1;
	     -webkit-transition: .2s;
	     transition: opacity .2s;
	 }
	 .slider:hover {
	     opacity: 1;
	 }
	 .slider::-webkit-slider-thumb {
	     -webkit-appearance: none;
	     appearance: none;
	     width: 60px;
	     height: 60px;
	     background: #262626;
	     cursor: pointer;
	 }
	 .slider::-moz-range-thumb {
	     width: 60px;
	     height: 60px;
	     background: #262626;
	     cursor: pointer;
	 }
	</style>
    </head>
    <body>
	<div style="font-size: 30px;font-weight: bold;text-align: center;width: 85% ;color: blue ">
	    MedidoPump
	</div>
	<canvas id="gauge";
		width: 95%;
		margin: auto;
		display: block>
	</canvas>
	<div style="font-size: 22px;font-weight: bold; line-height: 45px">
	    Fuel Flow Rate <span id="fuelFlowRate">0</span> oz/min
	    <br>
	    Total Fuel Flow <span id="totalFuelFlow">0</span> oz <button class="buttonClear"> Clear </button>
	    <br>
	    Running Time <span id="runningTime">0</span>
	    <br>
	</div>
	
	<input type="range" min="0" max="100" class="slider" value="0" id="pumpSpeed">
	<p></p>
	<div style="font-size: 20px;font-weight: bold">
	    Pump Speed (%): <span id="pumpDisp">0</span>
	</div>
	<br>
	<button class="button buttonFill"  id="Fill" >Fill </button>
	<button class="button buttonOff"   id="Off"  >Off  </button>
	<button class="button buttonEmpty" id="Empty">Empty</button>
	<p></p>
	<div style="font-size: 20px;font-weight: bold">    
	    Heap: <span id="heapSize">0</span>
	</div>
	<script>
	 var target = document.getElementById('gauge'); // your canvas element
	 var opts = {
	     angle: 0.05, // The span of the gauge arc
	     lineWidth: 0.35, // The line thickness
	     radiusScale: .9, // Relative radius
	     pointer: {
		 length: 0.6, // // Relative to gauge radius
		 strokeWidth: 0.035, // The thickness
		 color: '#000000' // Fill color
	     },
	     renderTicks: {
		 divisions: 8,
		 subDivisions: 4,
		 divLength: 0.3,
		 subLength: 0.15
	     },
	     staticLabels: {
		 labels: [-40,-20,0,20,40],
		 color: 'black',
		 font: "90% sans serif"
	     },
	     limitMax: true,     // If false, max value increases automatically if value > maxValue
	     limitMin: true,     // If true, the min value of the gauge will be fixed
	     generateGradient: true,
	     //highDpiSupport: true,     // High resolution support
	     colorStart: '#0039e6',   // Colors
	     colorStop: '#0039e6',    // just experiment with them
	     strokeColor: '#E0E0E0',  // to see which ones work best for you
	     fontSize: 30,
	     staticZones: [
		 {strokeStyle: "#f44336", min: -40, max: -2}, // Red from -40 to 0
		 {strokeStyle: "#e0e0e0", min: -2,  max: 2},  // Grey near zero
		 {strokeStyle: "#16aa20", min: 2,   max: 40}, // Green from 0 to 40
	     ],
	     //percentColors: [[0, "#f44336" ], [0.5, "#e0e0e0"], [1.0, "#16aa20"]],
	 };
	 var gauge = new Gauge(target).setOptions(opts); // create sexy gauge!
	 gauge.maxValue = 40; // set max gauge value
	 gauge.setMinValue(-40);  // Prefer setter over gauge.minValue = 0
	 gauge.animationSpeed = 10; // set animation speed (32 is default value)
	 gauge.set(flowRstr); // set actual value
	 
	</script>

	
    </body>
</html>
